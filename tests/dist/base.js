"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ShaderEdge = exports.ShaderEdgeSlot = exports.ShaderSlot = exports.ShaderSlotType = exports.resetGlobalShaderSlotID = exports.ShaderNode = exports.ShaderPropery = void 0;
const utils_1 = require("./utils");
class ShaderPropery {
    constructor(obj) {
        this.type = {};
        this.data = {};
        this.name = '';
        this.type = obj.type;
        this.data = utils_1.getJsonObject(obj.JSONnodeData);
        this.name = this.data.m_Name;
        this.name = this.name.replace(/ /g, '_');
    }
    get defaultValue() {
        return this.data.m_Value;
    }
    get concretePrecision() {
        let concretePrecision = 1;
        let value = this.defaultValue;
        if (typeof value === 'object') {
            if (value.w !== undefined || value.r !== undefined) {
                concretePrecision = 4;
            }
            else if (value.z !== undefined || value.g !== undefined) {
                concretePrecision = 3;
            }
            else if (value.y !== undefined || value.b !== undefined) {
                concretePrecision = 2;
            }
        }
        return concretePrecision;
    }
}
exports.ShaderPropery = ShaderPropery;
class ShaderNode {
    constructor(data) {
        this.type = {};
        this.data = {};
        this.priority = 0;
        this.uuid = '';
        this.slots = [];
        this.slotsMap = new Map;
        this.deps = [];
        this.isMasterNode = false;
        this.fixedConcretePrecision = false;
        this.type = data.typeInfo;
        this.data = utils_1.getJsonObject(data.JSONnodeData);
        this.uuid = this.data.m_GuidSerialized;
        this.slots = this.data.m_SerializableSlots.map(d => {
            let slot = new ShaderSlot(d, this);
            this.slotsMap.set(slot.id, slot);
            return slot;
        });
    }
    addDependency(dep) {
        if (!this.deps.includes(dep)) {
            this.deps.push(dep);
        }
    }
    calcConcretePrecision() {
        if (!this.fixedConcretePrecision) {
            let minConcretePrecision = 999;
            this.inputSlots.forEach(slot => {
                let concretePrecision = slot.concretePrecision;
                if (slot.connectSlot) {
                    concretePrecision = slot.connectSlot.concretePrecision;
                }
                minConcretePrecision = Math.min(minConcretePrecision, concretePrecision);
            });
            this.slots.forEach(slot => {
                slot._concretePrecision = minConcretePrecision;
            });
        }
    }
    setPriority(priority) {
        this.priority = Math.max(priority, this.priority);
        for (let i = 0; i < this.deps.length; i++) {
            this.deps[i].setPriority(this.priority + 1);
        }
    }
    get outputSlots() {
        return this.slots.filter(s => s.type === ShaderSlotType.Output);
    }
    get inputSlots() {
        return this.slots.filter(s => s.type === ShaderSlotType.Input);
    }
    getOutputSlotWithSlotName(name) {
        return this.outputSlots.find(s => s.data.m_DisplayName === name);
    }
    getOutputVarName(idx) {
        return this.outputSlots[idx].varName;
    }
    getOutputVarDefine(idx) {
        return this.outputSlots[idx].varDefine;
    }
    getInputValue(idx) {
        return this.inputSlots[idx].slotValue;
    }
    generateCode() {
        return '';
    }
}
exports.ShaderNode = ShaderNode;
let _GlobalShaderSlotID_ = 0;
function resetGlobalShaderSlotID() {
    _GlobalShaderSlotID_ = 0;
}
exports.resetGlobalShaderSlotID = resetGlobalShaderSlotID;
var ShaderSlotType;
(function (ShaderSlotType) {
    ShaderSlotType[ShaderSlotType["Input"] = 0] = "Input";
    ShaderSlotType[ShaderSlotType["Output"] = 1] = "Output";
})(ShaderSlotType = exports.ShaderSlotType || (exports.ShaderSlotType = {}));
class ShaderSlot {
    constructor(obj, node) {
        this.typeInfo = {};
        this.data = {};
        this.id = 0;
        this.globalID = 0;
        this.connectSlot = null;
        this.node = null;
        this.type = ShaderSlotType.Input;
        this._concretePrecision = -1;
        this.typeInfo = obj.typeInfo;
        this.data = utils_1.getJsonObject(obj.JSONnodeData);
        this.type = this.data.m_SlotType;
        this.node = node;
        this.id = this.data.m_Id;
        this.globalID = _GlobalShaderSlotID_++;
    }
    get varName() {
        return 'var_' + this.globalID;
    }
    get varDefine() {
        let precision = '';
        if (this.concretePrecision === 1) {
            precision = 'float';
        }
        else if (this.concretePrecision === 2) {
            precision = 'vec2';
        }
        else if (this.concretePrecision === 3) {
            precision = 'vec3';
        }
        else if (this.concretePrecision === 4) {
            precision = 'vec4';
        }
        if (precision) {
            precision += ' ';
        }
        return precision + this.varName;
    }
    get slotValue() {
        var _a;
        let result;
        let valueConretePresition = this.defaultConcretePrecision;
        let defaultValue = this.data.m_Value;
        let x = utils_1.getFloatString(defaultValue.x);
        let y = utils_1.getFloatString(defaultValue.y);
        let z = utils_1.getFloatString(defaultValue.z);
        let w = utils_1.getFloatString(defaultValue.w);
        if (!this.connectSlot) {
            if ((_a = this.node) === null || _a === void 0 ? void 0 : _a.isMasterNode) {
                return null;
            }
            result = defaultValue;
            if (typeof defaultValue === 'object') {
                if (defaultValue.w !== undefined) {
                    result = `vec4(${x}, ${y}, ${z}, ${w})`;
                }
                else if (defaultValue.z !== undefined) {
                    result = `vec3(${x}, ${y}, ${z})`;
                }
                else if (defaultValue.y !== undefined) {
                    result = `vec2(${x}, ${y})`;
                }
            }
        }
        else {
            result = this.connectSlot.varName;
            valueConretePresition = this.connectSlot.concretePrecision;
        }
        if (this.concretePrecision !== valueConretePresition) {
            if (this.concretePrecision < valueConretePresition) {
                if (this.concretePrecision === 1) {
                    result += '.x';
                }
                else if (this.concretePrecision === 2) {
                    result += '.xy';
                }
                else if (this.concretePrecision === 3) {
                    result += '.xyz';
                }
            }
            else {
                let dif = this.concretePrecision - valueConretePresition;
                let str = '';
                if (dif === 1) {
                    str += `${x}`;
                }
                else if (dif === 2) {
                    str += `${x}, ${y}`;
                }
                else if (dif === 3) {
                    str += `${x}, ${y}, ${z}`;
                }
                if (this.concretePrecision === 2) {
                    result = `vec2(${result}, ${str});`;
                }
                else if (this.concretePrecision === 3) {
                    result = `vec3(${result}, ${str})`;
                }
                else if (this.concretePrecision === 4) {
                    result = `vec4(${result}, ${str})`;
                }
            }
        }
        return result;
    }
    get defaultConcretePrecision() {
        let concretePrecision = 1;
        let value = this.data.m_Value;
        if (typeof value === 'object') {
            if (value.w !== undefined) {
                concretePrecision = 4;
            }
            else if (value.z !== undefined) {
                concretePrecision = 3;
            }
            else if (value.y !== undefined) {
                concretePrecision = 2;
            }
        }
        return concretePrecision;
    }
    get concretePrecision() {
        if (this._concretePrecision === -1) {
            this._concretePrecision = 1;
            let value = this.data.m_Value;
            if (typeof value === 'object') {
                if (value.w !== undefined) {
                    this._concretePrecision = 4;
                }
                else if (value.z !== undefined) {
                    this._concretePrecision = 3;
                }
                else if (value.y !== undefined) {
                    this._concretePrecision = 2;
                }
            }
        }
        return this._concretePrecision;
    }
}
exports.ShaderSlot = ShaderSlot;
class ShaderEdgeSlot {
    constructor() {
        this.id = 0;
        this.nodeUuid = '';
    }
    set(data) {
        this.id = data.m_SlotId;
        this.nodeUuid = data.m_NodeGUIDSerialized;
    }
}
exports.ShaderEdgeSlot = ShaderEdgeSlot;
class ShaderEdge {
    constructor(data) {
        this.type = {};
        this.data = {};
        this.input = new ShaderEdgeSlot;
        this.output = new ShaderEdgeSlot;
        this.type = data.typeInfo;
        this.data = utils_1.getJsonObject(data.JSONnodeData);
        this.input.set(this.data.m_InputSlot);
        this.output.set(this.data.m_OutputSlot);
    }
}
exports.ShaderEdge = ShaderEdge;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUF3RDtBQUd4RCxNQUFhLGFBQWE7SUFNdEIsWUFBYSxHQUFRO1FBTHJCLFNBQUksR0FBRyxFQUFFLENBQUM7UUFDVixTQUFJLEdBQVEsRUFBRSxDQUFBO1FBRWQsU0FBSSxHQUFHLEVBQUUsQ0FBQztRQUdOLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLHFCQUFhLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRTVDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQUksWUFBWTtRQUNaLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQ2pCLElBQUksaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO1FBRTFCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDOUIsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxLQUFLLENBQUMsQ0FBQyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDaEQsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDO2FBQ3pCO2lCQUNJLElBQUksS0FBSyxDQUFDLENBQUMsS0FBSyxTQUFTLElBQUksS0FBSyxDQUFDLENBQUMsS0FBSyxTQUFTLEVBQUU7Z0JBQ3JELGlCQUFpQixHQUFHLENBQUMsQ0FBQzthQUN6QjtpQkFDSSxJQUFJLEtBQUssQ0FB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SSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDSjtBQWRELGdDQWNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0SnNvbk9iamVjdCwgZ2V0RmxvYXRTdHJpbmcgfSBmcm9tIFwiLi91dGlsc1wiO1xyXG5pbXBvcnQgeyBlbWl0IH0gZnJvbSBcInByb2Nlc3NcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBTaGFkZXJQcm9wZXJ5IHtcclxuICAgIHR5cGUgPSB7fTtcclxuICAgIGRhdGE6IGFueSA9IHt9XHJcblxyXG4gICAgbmFtZSA9ICcnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yIChvYmo6IGFueSkge1xyXG4gICAgICAgIHRoaXMudHlwZSA9IG9iai50eXBlO1xyXG4gICAgICAgIHRoaXMuZGF0YSA9IGdldEpzb25PYmplY3Qob2JqLkpTT05ub2RlRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMubmFtZSA9IHRoaXMuZGF0YS5tX05hbWU7XHJcbiAgICAgICAgdGhpcy5uYW1lID0gdGhpcy5uYW1lLnJlcGxhY2UoLyAvZywgJ18nKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZGVmYXVsdFZhbHVlICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLm1fVmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNvbmNyZXRlUHJlY2lzaW9uICgpIHtcclxuICAgICAgICBsZXQgY29uY3JldGVQcmVjaXNpb24gPSAxO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmRlZmF1bHRWYWx1ZTtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUudyAhPT0gdW5kZWZpbmVkIHx8IHZhbHVlLnIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29uY3JldGVQcmVjaXNpb24gPSA0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHZhbHVlLnogIT09IHVuZGVmaW5lZCB8fCB2YWx1ZS5nICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbmNyZXRlUHJlY2lzaW9uID0gMztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS55ICE9PSB1bmRlZmluZWQgfHwgdmFsdWUuYiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25jcmV0ZVByZWNpc2lvbiA9IDI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjb25jcmV0ZVByZWNpc2lvbjtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFNoYWRlck5vZGUge1xyXG4gICAgdHlwZSA9IHt9O1xyXG4gICAgZGF0YTogYW55ID0ge31cclxuXHJcbiAgICBwcmlvcml0eSA9IDA7XHJcbiAgICB1dWlkID0gJyc7XHJcbiAgICBzbG90czogU2hhZGVyU2xvdFtdID0gW107XHJcbiAgICBzbG90c01hcDogTWFwPG51bWJlciwgU2hhZGVyU2xvdD4gPSBuZXcgTWFwO1xyXG5cclxuICAgIGRlcHM6IFNoYWRlck5vZGVbXSA9IFtdXHJcblxyXG4gICAgaXNNYXN0ZXJOb2RlID0gZmFsc2U7XHJcbiAgICBmaXhlZENvbmNyZXRlUHJlY2lzaW9uID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IgKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHRoaXMudHlwZSA9IGRhdGEudHlwZUluZm87XHJcbiAgICAgICAgdGhpcy5kYXRhID0gZ2V0SnNvbk9iamVjdChkYXRhLkpTT05ub2RlRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMudXVpZCA9IHRoaXMuZGF0YS5tX0d1aWRTZXJpYWxpemVkO1xyXG4gICAgICAgIHRoaXMuc2xvdHMgPSB0aGlzLmRhdGEubV9TZXJpYWxpemFibGVTbG90cy5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIGxldCBzbG90ID0gbmV3IFNoYWRlclNsb3QoZCwgdGhpcyk7XHJcbiAgICAgICAgICAgIHRoaXMuc2xvdHNNYXAuc2V0KHNsb3QuaWQsIHNsb3QpO1xyXG4gICAgICAgICAgICByZXR1cm4gc2xvdDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhZGREZXBlbmRlbmN5IChkZXApIHtcclxuICAgICAgICBpZiAoIXRoaXMuZGVwcy5pbmNsdWRlcyhkZXApKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVwcy5wdXNoKGRlcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNhbGNDb25jcmV0ZVByZWNpc2lvbiAoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmZpeGVkQ29uY3JldGVQcmVjaXNpb24pIHtcclxuICAgICAgICAgICAgbGV0IG1pbkNvbmNyZXRlUHJlY2lzaW9uID0gOTk5O1xyXG4gICAgICAgICAgICB0aGlzLmlucHV0U2xvdHMuZm9yRWFjaChzbG90ID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCBjb25jcmV0ZVByZWNpc2lvbiA9IHNsb3QuY29uY3JldGVQcmVjaXNpb247XHJcbiAgICAgICAgICAgICAgICBpZiAoc2xvdC5jb25uZWN0U2xvdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmNyZXRlUHJlY2lzaW9uID0gc2xvdC5jb25uZWN0U2xvdC5jb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG1pbkNvbmNyZXRlUHJlY2lzaW9uID0gTWF0aC5taW4obWluQ29uY3JldGVQcmVjaXNpb24sIGNvbmNyZXRlUHJlY2lzaW9uKTtcclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2xvdHMuZm9yRWFjaChzbG90ID0+IHtcclxuICAgICAgICAgICAgICAgIHNsb3QuX2NvbmNyZXRlUHJlY2lzaW9uID0gbWluQ29uY3JldGVQcmVjaXNpb247XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFByaW9yaXR5IChwcmlvcml0eSkge1xyXG4gICAgICAgIHRoaXMucHJpb3JpdHkgPSBNYXRoLm1heChwcmlvcml0eSwgdGhpcy5wcmlvcml0eSk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRlcHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdGhpcy5kZXBzW2ldLnNldFByaW9yaXR5KHRoaXMucHJpb3JpdHkgKyAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IG91dHB1dFNsb3RzICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zbG90cy5maWx0ZXIocyA9PiBzLnR5cGUgPT09IFNoYWRlclNsb3RUeXBlLk91dHB1dCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGlucHV0U2xvdHMgKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNsb3RzLmZpbHRlcihzID0+IHMudHlwZSA9PT0gU2hhZGVyU2xvdFR5cGUuSW5wdXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldE91dHB1dFNsb3RXaXRoU2xvdE5hbWUgKG5hbWUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vdXRwdXRTbG90cy5maW5kKHMgPT4gcy5kYXRhLm1fRGlzcGxheU5hbWUgPT09IG5hbWUpO1xyXG4gICAgfVxyXG4gICAgZ2V0T3V0cHV0VmFyTmFtZSAoaWR4KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3V0cHV0U2xvdHNbaWR4XS52YXJOYW1lO1xyXG4gICAgfVxyXG4gICAgZ2V0T3V0cHV0VmFyRGVmaW5lIChpZHgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vdXRwdXRTbG90c1tpZHhdLnZhckRlZmluZTtcclxuICAgIH1cclxuICAgIGdldElucHV0VmFsdWUgKGlkeCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmlucHV0U2xvdHNbaWR4XS5zbG90VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2VuZXJhdGVDb2RlICgpIHtcclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmxldCBfR2xvYmFsU2hhZGVyU2xvdElEXyA9IDA7XHJcbmV4cG9ydCBmdW5jdGlvbiByZXNldEdsb2JhbFNoYWRlclNsb3RJRCAoKSB7XHJcbiAgICBfR2xvYmFsU2hhZGVyU2xvdElEXyA9IDA7XHJcbn1cclxuXHJcbmV4cG9ydCBlbnVtIFNoYWRlclNsb3RUeXBlIHtcclxuICAgIElucHV0LFxyXG4gICAgT3V0cHV0XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTaGFkZXJTbG90IHtcclxuICAgIHR5cGVJbmZvID0ge307XHJcbiAgICBkYXRhOiBhbnkgPSB7fVxyXG5cclxuICAgIGlkID0gMDtcclxuXHJcbiAgICBnbG9iYWxJRCA9IDA7XHJcblxyXG4gICAgY29ubmVjdFNsb3Q6IFNoYWRlclNsb3QgfCBudWxsIHwgdW5kZWZpbmVkID0gbnVsbDtcclxuICAgIG5vZGU6IFNoYWRlck5vZGUgfCBudWxsIHwgdW5kZWZpbmVkID0gbnVsbDtcclxuXHJcbiAgICB0eXBlID0gU2hhZGVyU2xvdFR5cGUuSW5wdXQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IgKG9iajogYW55LCBub2RlOiBTaGFkZXJOb2RlKSB7XHJcbiAgICAgICAgdGhpcy50eXBlSW5mbyA9IG9iai50eXBlSW5mbztcclxuICAgICAgICB0aGlzLmRhdGEgPSBnZXRKc29uT2JqZWN0KG9iai5KU09Obm9kZURhdGEpO1xyXG5cclxuICAgICAgICB0aGlzLnR5cGUgPSB0aGlzLmRhdGEubV9TbG90VHlwZSBhcyBTaGFkZXJTbG90VHlwZTtcclxuXHJcbiAgICAgICAgdGhpcy5ub2RlID0gbm9kZTtcclxuXHJcbiAgICAgICAgdGhpcy5pZCA9IHRoaXMuZGF0YS5tX0lkO1xyXG4gICAgICAgIHRoaXMuZ2xvYmFsSUQgPSBfR2xvYmFsU2hhZGVyU2xvdElEXysrO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB2YXJOYW1lICgpIHtcclxuICAgICAgICByZXR1cm4gJ3Zhcl8nICsgdGhpcy5nbG9iYWxJRDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdmFyRGVmaW5lICgpIHtcclxuICAgICAgICBsZXQgcHJlY2lzaW9uID0gJyc7XHJcbiAgICAgICAgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb24gPT09IDEpIHtcclxuICAgICAgICAgICAgcHJlY2lzaW9uID0gJ2Zsb2F0JztcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAodGhpcy5jb25jcmV0ZVByZWNpc2lvbiA9PT0gMikge1xyXG4gICAgICAgICAgICBwcmVjaXNpb24gPSAndmVjMic7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb24gPT09IDMpIHtcclxuICAgICAgICAgICAgcHJlY2lzaW9uID0gJ3ZlYzMnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmICh0aGlzLmNvbmNyZXRlUHJlY2lzaW9uID09PSA0KSB7XHJcbiAgICAgICAgICAgIHByZWNpc2lvbiA9ICd2ZWM0JztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHByZWNpc2lvbikge1xyXG4gICAgICAgICAgICBwcmVjaXNpb24gKz0gJyAnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJlY2lzaW9uICsgdGhpcy52YXJOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBzbG90VmFsdWUgKCkge1xyXG4gICAgICAgIGxldCByZXN1bHQ7XHJcbiAgICAgICAgbGV0IHZhbHVlQ29ucmV0ZVByZXNpdGlvbiA9IHRoaXMuZGVmYXVsdENvbmNyZXRlUHJlY2lzaW9uO1xyXG4gICAgICAgIGxldCBkZWZhdWx0VmFsdWUgPSB0aGlzLmRhdGEubV9WYWx1ZTtcclxuICAgICAgICBcclxuICAgICAgICBsZXQgeCA9IGdldEZsb2F0U3RyaW5nKGRlZmF1bHRWYWx1ZS54KTtcclxuICAgICAgICBsZXQgeSA9IGdldEZsb2F0U3RyaW5nKGRlZmF1bHRWYWx1ZS55KTtcclxuICAgICAgICBsZXQgeiA9IGdldEZsb2F0U3RyaW5nKGRlZmF1bHRWYWx1ZS56KTtcclxuICAgICAgICBsZXQgdyA9IGdldEZsb2F0U3RyaW5nKGRlZmF1bHRWYWx1ZS53KTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmNvbm5lY3RTbG90KSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5vZGU/LmlzTWFzdGVyTm9kZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzdWx0ID0gZGVmYXVsdFZhbHVlO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGRlZmF1bHRWYWx1ZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUudyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYHZlYzQoJHt4fSwgJHt5fSwgJHt6fSwgJHt3fSlgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZGVmYXVsdFZhbHVlLnogIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGB2ZWMzKCR7eH0sICR7eX0sICR7en0pYDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRlZmF1bHRWYWx1ZS55ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBgdmVjMigke3h9LCAke3l9KWA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMuY29ubmVjdFNsb3QudmFyTmFtZTtcclxuICAgICAgICAgICAgdmFsdWVDb25yZXRlUHJlc2l0aW9uID0gdGhpcy5jb25uZWN0U2xvdC5jb25jcmV0ZVByZWNpc2lvbjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbmNyZXRlUHJlY2lzaW9uICE9PSB2YWx1ZUNvbnJldGVQcmVzaXRpb24pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb24gPCB2YWx1ZUNvbnJldGVQcmVzaXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbmNyZXRlUHJlY2lzaW9uID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICcueCc7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLmNvbmNyZXRlUHJlY2lzaW9uID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9ICcueHknO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jb25jcmV0ZVByZWNpc2lvbiA9PT0gMykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAnLnh5eic7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGlmID0gdGhpcy5jb25jcmV0ZVByZWNpc2lvbiAtIHZhbHVlQ29ucmV0ZVByZXNpdGlvbjtcclxuICAgICAgICAgICAgICAgIGxldCBzdHIgPSAnJztcclxuICAgICAgICAgICAgICAgIGlmIChkaWYgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdHIgKz0gYCR7eH1gO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZGlmID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RyICs9IGAke3h9LCAke3l9YDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRpZiA9PT0gMykge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0ciArPSBgJHt4fSwgJHt5fSwgJHt6fWA7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb24gPT09IDIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBgdmVjMigke3Jlc3VsdH0sICR7c3RyfSk7YDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY29uY3JldGVQcmVjaXNpb24gPT09IDMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBgdmVjMygke3Jlc3VsdH0sICR7c3RyfSlgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5jb25jcmV0ZVByZWNpc2lvbiA9PT0gNCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGB2ZWM0KCR7cmVzdWx0fSwgJHtzdHJ9KWA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgZGVmYXVsdENvbmNyZXRlUHJlY2lzaW9uICgpIHtcclxuICAgICAgICBsZXQgY29uY3JldGVQcmVjaXNpb24gPSAxO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmRhdGEubV9WYWx1ZTtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUudyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25jcmV0ZVByZWNpc2lvbiA9IDQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUueiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25jcmV0ZVByZWNpc2lvbiA9IDM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUueSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25jcmV0ZVByZWNpc2lvbiA9IDI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjb25jcmV0ZVByZWNpc2lvbjtcclxuICAgIH1cclxuXHJcbiAgICBfY29uY3JldGVQcmVjaXNpb24gPSAtMTtcclxuICAgIGdldCBjb25jcmV0ZVByZWNpc2lvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbmNyZXRlUHJlY2lzaW9uID09PSAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLl9jb25jcmV0ZVByZWNpc2lvbiA9IDE7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmRhdGEubV9WYWx1ZTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZS53ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25jcmV0ZVByZWNpc2lvbiA9IDQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS56ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25jcmV0ZVByZWNpc2lvbiA9IDM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh2YWx1ZS55ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jb25jcmV0ZVByZWNpc2lvbiA9IDI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmNyZXRlUHJlY2lzaW9uO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2hhZGVyRWRnZVNsb3Qge1xyXG4gICAgaWQgPSAwO1xyXG4gICAgbm9kZVV1aWQgPSAnJztcclxuXHJcbiAgICBzZXQgKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHRoaXMuaWQgPSBkYXRhLm1fU2xvdElkO1xyXG4gICAgICAgIHRoaXMubm9kZVV1aWQgPSBkYXRhLm1fTm9kZUdVSURTZXJpYWxpemVkO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2hhZGVyRWRnZSB7XHJcbiAgICB0eXBlID0ge307XHJcbiAgICBkYXRhOiBhbnkgPSB7fVxyXG5cclxuICAgIGlucHV0OiBTaGFkZXJFZGdlU2xvdCA9IG5ldyBTaGFkZXJFZGdlU2xvdDtcclxuICAgIG91dHB1dDogU2hhZGVyRWRnZVNsb3QgPSBuZXcgU2hhZGVyRWRnZVNsb3Q7XHJcblxyXG4gICAgY29uc3RydWN0b3IgKGRhdGE6IGFueSkge1xyXG4gICAgICAgIHRoaXMudHlwZSA9IGRhdGEudHlwZUluZm87XHJcbiAgICAgICAgdGhpcy5kYXRhID0gZ2V0SnNvbk9iamVjdChkYXRhLkpTT05ub2RlRGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5wdXQuc2V0KHRoaXMuZGF0YS5tX0lucHV0U2xvdCk7XHJcbiAgICAgICAgdGhpcy5vdXRwdXQuc2V0KHRoaXMuZGF0YS5tX091dHB1dFNsb3QpO1xyXG4gICAgfVxyXG59Il19